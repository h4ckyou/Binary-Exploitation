<h2> ROP Emporium </h2>

  - Challenge 3
  - Chall Name: callme

![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/cdccfd5f-33ca-4b7c-8fe4-7fc9675616bb)

**File Checks:-**

The zip file attached to this challenge contained this files (excluding *solve.py*)
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/a2985062-8f5e-4ed3-b40c-dca6d3175cc2)

The only thing we would look at is the binary and shared object library file
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/78bbb252-1a54-41ec-8975-d511a1909507)

Decompiling the binary in Ghidra and here's the main function
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/83c54b4e-8f52-4bdc-9bf9-5b4de8eafaf1)

Nothing interesting except it calling the `pwnme()` function
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/d929a1a6-66fb-4696-9e07-e87c0b5a8e12)

Another obious buffer overflow here cause it's reading at most 512 bytes into a buffer that can only hold up 32 bytes

Looking through the available functions I saw this
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/f30ce647-9eda-4521-9b6f-5f2d0e5a6ac3)

At first this looks like our goal right? To call this function!

Looking at the decompilation we know that it would call `callme_three()` first

If you try to decompile it you get this
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/28b0b0a5-61cc-4c2e-8584-6ea79369f36d)

WTF is this? 

Looking at the assembly equivalent should give this
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/aea10b3d-4833-4829-b882-a7f9d8fcd194)

It's calling that function from an external source that's what it means

Basically that function was imported from the `shared object library file (libcallme.so)` 

And the *Procedure Linkage Table (PLT)* is used to resolve function addresses in imported libraries at runtime

Now what do we do?

I used Ghidra to decompile the library file

Here's the `callme_three` function decompilation

![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/59194b42-8e1f-4e89-8d9f-c571bba86c3c)

We see that when it's called it compares the 3 argument we passed to the function to some values

Converting that negative values to `char` gives this
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/98a1ba22-c01c-4d94-b665-2da4543ccdc4)

But looking at the assembly we see this
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/3f0cd9d6-70d7-47f6-8dd5-923ce47ed643)

```
   0x0000000000000a35 <+8>:     mov    QWORD PTR [rbp-0x18],rdi
   0x0000000000000a39 <+12>:    mov    QWORD PTR [rbp-0x20],rsi
   0x0000000000000a3d <+16>:    mov    QWORD PTR [rbp-0x28],rdx
   0x0000000000000a41 <+20>:    movabs rax,0xdeadbeefdeadbeef
   0x0000000000000a4b <+30>:    cmp    QWORD PTR [rbp-0x18],rax
   0x0000000000000a4f <+34>:    jne    0xb81 <callme_three+340>
   0x0000000000000a55 <+40>:    movabs rax,0xcafebabecafebabe
   0x0000000000000a5f <+50>:    cmp    QWORD PTR [rbp-0x20],rax
   0x0000000000000a63 <+54>:    jne    0xb81 <callme_three+340>
   0x0000000000000a69 <+60>:    movabs rax,0xd00df00dd00df00d
   0x0000000000000a73 <+70>:    cmp    QWORD PTR [rbp-0x28],rax
```

So from the assembly instructions we can conclude that the required argument should be this:

```
callme_three(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
```

They seem to be other functions aside this which were called from the `usefulFunction()` function which are `callme_two() & callme_one()`

Here's the `callme_two()` function decompilation
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/aec7f6dd-6c40-46a6-a709-504c1291bc46)

And lastly the `callme_one()` function decompilation
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/aac16861-7863-416d-9753-6f07c5f41a14)

The callme_* functions uses the compares the argument passed to the function against the same value i.e

```
- callme_three(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
- callme_two(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
- callme_one(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
```

But one thing I noticed is that if we call `callme_three()` first this happens
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/64785935-0955-45d0-ac09-87aa9e452097)

Basically after it performs some operation it puts the value of `g_buf` to `stdout` then `exit()` (of cause that happens only when the argument passed to the function is right)

That means if we call it first the program execution would stop!

Unlike `callme_one & callme_two` they both would just `return` which would make the flow of execution continue

So that means that the right way to call this functions would be:

```
- callme_one(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
- callme_two(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
- callme_three(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)
```

Now that we know that let's call it?

First we need the offset which happens to always be 40 bytes in all the challenges so I won't find that here

Next we need ROP gadgets that would help in controlling the *rdi, rsi, rdx* register

Using `ropper` I found gadgets that helps in achieving that
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/aad036e2-31f9-4148-8256-8a4589217c52)
![image](https://github.com/h4ckyou/Binary-Exploitation/assets/127159644/da943e27-7e16-4b20-91ba-448a711a0bfa)

```
0x000000000040093c: pop rdi; pop rsi; pop rdx; ret; 
```




